name: Deploy to Production

# Feature: skids-e2e-deployment
# Validates: Requirements 6.1, 6.2, 6.3, 6.4, 6.5

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '18'

jobs:
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: skidadvanced/package-lock.json
      
      - name: Install dependencies
        working-directory: ./skidadvanced
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./skidadvanced
        run: npm run lint
      
      - name: Run TypeScript type check
        working-directory: ./skidadvanced
        run: npm run type-check

  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: skidadvanced/package-lock.json
      
      - name: Install dependencies
        working-directory: ./skidadvanced
        run: npm ci
      
      - name: Run property-based tests
        working-directory: ./skidadvanced
        run: npm run test:properties
        env:
          DATABASE_URL: file:./test.db
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: property-test-results
          path: skidadvanced/test-results/

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: skidadvanced/package-lock.json
      
      - name: Install dependencies
        working-directory: ./skidadvanced
        run: npm ci
      
      - name: Install Playwright browsers
        working-directory: ./skidadvanced
        run: npx playwright install --with-deps
      
      - name: Run E2E tests
        working-directory: ./skidadvanced
        run: npx playwright test
        env:
          DATABASE_URL: file:./test.db
          PLAYWRIGHT_BASE_URL: http://localhost:3000
      
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: skidadvanced/playwright-report/
          retention-days: 30

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [property-tests, e2e-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: skidadvanced/package-lock.json
      
      - name: Install dependencies
        working-directory: ./skidadvanced
        run: npm ci
      
      - name: Build Next.js application
        working-directory: ./skidadvanced
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            skidadvanced/.next/
            skidadvanced/public/
          retention-days: 1

  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: skidadvanced/package-lock.json
      
      - name: Install dependencies
        working-directory: ./skidadvanced
        run: npm ci
      
      - name: Build for production
        working-directory: ./skidadvanced
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          CLOUDFLARE_R2_ENDPOINT: ${{ secrets.CLOUDFLARE_R2_ENDPOINT }}
          CLOUDFLARE_R2_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
          CLOUDFLARE_R2_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: skids-advanced
          directory: skidadvanced/.next
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run health checks
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30
          
          HEALTH_URL="${{ secrets.PRODUCTION_URL }}/api/health"
          echo "Checking health at: $HEALTH_URL"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
          
          if [ $RESPONSE -eq 200 ]; then
            echo "‚úÖ Health check passed"
            exit 0
          else
            echo "‚ùå Health check failed with status: $RESPONSE"
            exit 1
          fi
      
      - name: Notify deployment success
        if: success()
        run: |
          echo "üöÄ Deployment successful!"
          echo "Production URL: ${{ secrets.PRODUCTION_URL }}"
      
      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check logs for details"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Rollback deployment
        run: |
          echo "üîÑ Rolling back to previous version..."
          # Cloudflare Pages handles rollback automatically
          # This step is for logging and notifications
          echo "Rollback initiated. Previous stable version will be restored."
